<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🦄&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>Tournament分支预测器简介&nbsp;|&nbsp;SnoopyBug</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="Tournament分支预测器简介">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;💡&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🦄&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;😀&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>About</span>
        </div>
      </a>
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;💡&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">Tournament分支预测器简介</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Thu, Mar 31, 2022</span>
        
        
      </div>
    
  </header>
  <article id="https://www.notion.so/23962e26a1cf80c4ab76e674455c59ae" class="PageRoot"><h2 id="https://www.notion.so/23962e26a1cf8086a4dbfed0982701d1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/23962e26a1cf8086a4dbfed0982701d1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">1 思路</span></span></h2><div id="https://www.notion.so/23962e26a1cf80e7b29dcd41f55b8d9b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">基于已有的Gshare分支预测器，希望对其优化来提高预测精度。能够优化的方面可能有3个：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/23962e26a1cf80019459fe9a9b339b37" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">增加GHR（global history register）的长度，使用更多的全局历史信息；</span></span></li><li id="https://www.notion.so/23962e26a1cf809c8f08cb4cf985f1c9" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">增加PHT（pattern history table）中状态机的状态编码长度，使其拥有更多状态；</span></span></li><li id="https://www.notion.so/23962e26a1cf80c18231dfb7eda75670" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">优化Hash函数，或者使用其他方法进行预测。</span></span></li></ol><div id="https://www.notion.so/23962e26a1cf8099b694e0fd03ce8137" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">前期通过对上面提到的方法进行测试，发现前两种方法的影响不如第3种方法带来的影响大，并且优化预测方法更具彻底性。因此决定：先优化预测方法，再对GHR长度和状态编码长度进行调参，得到最优方法。</span></span></p></div><h2 id="https://www.notion.so/23962e26a1cf80f58019d73e79736b19" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/23962e26a1cf80f58019d73e79736b19"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2 分析</span></span></h2><h3 id="https://www.notion.so/23962e26a1cf808bae2ede9c910cb862" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/23962e26a1cf808bae2ede9c910cb862"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">（1）预测方法</strong></span></span></h3><div id="https://www.notion.so/23962e26a1cf80e7863af1f7ef77fdc1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">①使用局部历史进行预测</strong></span></span></p></div><div id="https://www.notion.so/23962e26a1cf80f285f2e6061f8ce828" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">已有的Gshare分支预测器：使用有限个全局历史编码串和分支地址的一部分进行异或，将结果作为索引在PHT中寻找状态，通过状态值来预测是否跳转。</span></span></p></div><pre id="https://www.notion.so/23962e26a1cf8068a731f53a3a0e9287" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>UINT32 phtIndex <span class="token operator">=</span> <span class="token punctuation">(</span>PC <span class="token operator">^</span> ghr<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>numPhtEntries<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// numPhtEntries 为PHT中的项数</span>
UINT32 phtCounter <span class="token operator">=</span> pht<span class="token punctuation">[</span>phtIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/23962e26a1cf804d9ae8fa47837469b1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">但只基于全局历史的预测是有风险的，当全局历史不那么规律时，预测器的表现将十分糟糕。但可能这种情况下，对于同一指令，它的局部历史是比较规律的。考虑：当PC相同时，可以认为是同一条指令。因此对于每一个PC，使其拥有独立的BHR（branch history register）来代替GHR来进行上述操作可能会提高预测精度。</span></span></p></div><pre id="https://www.notion.so/23962e26a1cf80a8b9b8ed7dbb43607b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">// branch history register table</span>
bhrt <span class="token operator">=</span> <span class="token punctuation">(</span>UINT32 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>numPhtEntries <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>UINT32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// HIST_LEN 为GRH长度</span>
UINT32 bhrtIndex <span class="token operator">=</span> <span class="token punctuation">(</span>PC <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>HIST_LEN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>numPhtEntries<span class="token punctuation">)</span><span class="token punctuation">;</span>
UINT32 phtIndex <span class="token operator">=</span> <span class="token punctuation">(</span>PC <span class="token operator">^</span> bhrt<span class="token punctuation">[</span>bhrtIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>numPhtEntries<span class="token punctuation">)</span><span class="token punctuation">;</span>
UINT32 phtCounter <span class="token operator">=</span> pht<span class="token punctuation">[</span>phtIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/23962e26a1cf80e0a8a6c38f5801cc8b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">②融合全局与局部历史</strong></span></span></p></div><div id="https://www.notion.so/23962e26a1cf80dbbb8ddb8cab519327" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">使用局部历史相比使用全局历史的预测精度确实提高不少，但只基于局部历史的话，GHR就失去作用了。希望将全局历史信息与局部历史信息融合，采用了Tournament预测器：</span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/23962e26a1cf8051bbccdae0c2a4ab5e" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString">Tournament预测器基于全局预测和局部预测进行综合考虑；</span></span></li><li id="https://www.notion.so/23962e26a1cf806fab46eee5ba0f417b" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString">全局预测与局部预测独立进行，由选择器选择其中一个方法的预测结果作为最终预测结果；</span></span></li><li id="https://www.notion.so/23962e26a1cf8072b6fcfbccf0187567" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString">和PHT类似，选择器实质上也是一个长度为 </span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Math" data-latex="2^k"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mi>k</mi></msup></mrow><annotation encoding="application/x-tex">2^k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.849108em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="SemanticString">的状态表，使用GHR的低k位进行索引。（也可以用PC或者PC^GHR来索引，效果还不错）；</span></span></li><li id="https://www.notion.so/23962e26a1cf80fb99d2c6c8035a69a1" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString">对于选择器中的一个状态，如果全局预测和局部预测结果一致，状态不变；否则：对于该状态，如果局部预测正确就+1，全局预测正确就-1；</span></span></li></ol><div id="https://www.notion.so/23962e26a1cf80d5b8bded22bd47fd87" class="Image Image--PageWidth"><figure><a href="attachment:f3a68447-338b-46d7-b900-891058d97c89:5.png?width=2182"><img src="attachment:f3a68447-338b-46d7-b900-891058d97c89:5.png?width=2182" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/23962e26a1cf8010bf66e83b28ddf550" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">优点：综合全局和局部历史信息，精度较高；</span></span></li><li id="https://www.notion.so/23962e26a1cf80b78a3adc89b9af0295" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">缺点：Tournament预测器的空间占用是比较大的，因为不仅有两个预测器，还有一个选择器。</span></span></li></ul><h3 id="https://www.notion.so/23962e26a1cf8036a505ee0a2b7bede7" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/23962e26a1cf8036a505ee0a2b7bede7"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">（2）状态编码长度</strong></span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/23962e26a1cf809b9a2edf2818c5d12b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">长度太短：每个状态蕴含的历史信息较少，使得历史信息在状态机中发挥的作用较小；</span></span></li><li id="https://www.notion.so/23962e26a1cf80f197a3e4dbaed8701f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">长度太长：信息冗余，且对时间上较近的跳转结果不灵敏，无法及时改变预测值。</span></span></li></ul><h3 id="https://www.notion.so/23962e26a1cf800c87ffc7bf1385cdcc" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/23962e26a1cf800c87ffc7bf1385cdcc"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">（3）GHR长度</strong></span></span></h3><ul class="BulletedListWrapper"><li id="https://www.notion.so/23962e26a1cf806c8d7ff53922acdd24" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">长度太短：全局历史信息太少，精度可能不高；</span></span></li><li id="https://www.notion.so/23962e26a1cf80a4b838dff8f6474cd4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">长度太长：虽然精度可能有所提高，但空间代价是巨大的。</span></span></li></ul><h2 id="https://www.notion.so/23962e26a1cf8018879afdcc84bf9a9a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/23962e26a1cf8018879afdcc84bf9a9a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">3 结果</strong></span></span></h2><div id="https://www.notion.so/23962e26a1cf804b9c67c4c37cd2180b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">预测器在不同测试集（L1, L2, ...)下的测试结果（每执行1k条指令的错误预测数）如下：</span></span></p></div><div id="https://www.notion.so/23962e26a1cf80189334c0deb21969ef" class="Image Image--PageWidth"><figure><a href="attachment:541fa637-1ae4-424f-814d-00030a4a9d8f:4.png?width=2296"><img src="attachment:541fa637-1ae4-424f-814d-00030a4a9d8f:4.png?width=2296" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/23962e26a1cf804fa398db374c2008b0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可以看出，当GHR取低26位时，Tournament预测器表现较好。但考虑到空间消耗，退而求其次，取22位或者18位时的平均精度相较初始的Gshare预测器依然大幅提升了。</span></span></p></div><div id="https://www.notion.so/23962e26a1cf809fb43ec420b23e209c" class="Image Image--PageWidth"><figure><a href="https://pic1.zhimg.com/v2-c5b0f626202817ded9fee4cb1790cff6_1440w.jpg"><img src="https://pic1.zhimg.com/v2-c5b0f626202817ded9fee4cb1790cff6_1440w.jpg" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div></article>
  <footer class="Footer">
  <div>&copy; SnoopyBug 2024</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>

</body>

</html>